<%args>
$transformation_id
</%args>

<&| /page/info_section.mas, title => 'Transformants (Accessions) Derived from this Transformation ', collapsible=>1, collapsed=>0 &>
    <div class = "well well-sm">
        <div class = "panel panel-default">
            <div class = "panel-body">
                <div style="overflow:scroll">
                    <table class="table table-hover table-bordered" id="transformants_table">
                    </table>
                </div>
                <div class="panel panel-default">
                    <div class="panel-body">
                        <&| /page/info_section.mas, title => 'Add transformants (accessions) to a List', collapsible=>1, collapsed=>1, subtitle=>'<i>Adding transformants (accessions) to a new or exisiting list</i>'&>
                            <br>
                            <div id="transformant_to_new_list" style="display:none"></div>
                            <div id="transformant_add_to_list"></div>
                        </&>
                    </div>
                </div>
            </div>
        </div>
    </div>
</&>

<div class="modal fade" id="obsolete_transformant_dialog" name="obsolete_transformant_dialog" tabindex="-1" role="dialog" aria-labelledby="obsoleteTransformantDialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="obsoleteTransformantDialog">Obsolete Transformant</h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div id="obsolete_transformant_div">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button id="obsolete_transformant_button" type="button" class="btn btn-primary" >Obsolete</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="obsolete_transformant_message_dialog" name="obsolete_transformant_message_dialog" tabindex="-1" role="dialog" aria-labelledby="obsoleteTransformantMessageDialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="obsoleteTransformantMessageDialog">Success</h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <p>
                        <span class="ui-icon ui-icon-circle-check" style="float: left; margin: 0 7px 50px 0;"></span>
                        Successfully obsoleted!.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button id="dismiss_obsolete_transformant_message_dialog" type="button" class="btn btn-default" data-dismiss="modal">Close & Reload</button>
            </div>
        </div>
    </div>
</div>

<script>

jQuery(document).ready(function(){

    const transformation_stock_id = "<%$transformation_id%>";
    const transformants_table = jQuery('#transformants_table').DataTable({
        'ajax': '/ajax/transformation/transformants/'+transformation_stock_id,
        'autoWidth': false,
        'columns': [
            { title: "Accession", "data": null, "render": function ( data, type, row ) { return "<a href='/stock/"+row.transformant_id+"/view'>"+row.transformant_name+"</a>"; } },
            { title: "Obsolete Accession", "data": "null", "render": function ( data, type, row ) { return "<a onclick='obsoleteTransformantDialog("+row.transformant_id+",\""+row.transformant_name+"\")'>X</a>"; } },
        ],

        "fnInitComplete": function(oSettings, json) {
            //console.log(json);
            if (!isLoggedIn()) {
                jQuery('#transformant_add_to_list').html("<div class='well well-sm'><h3>Please login to use lists!</h3></div>");
            } else {
                let html = "";
                for(let i=0; i<json.data.length; i++){
                    html += json.data[i].transformant_name+"\n";
                }

                jQuery("#transformant_to_new_list").html(html);
                addToListMenu("transformant_add_to_list", "transformant_to_new_list", {
                    selectText: true,
                    listType: 'accessions',
                });
            }
        }
    });

    jQuery('#obsolete_transformant_button').click( function() {

        const comments = jQuery('#obsolete_transformant_comments').val();
        if (!comments) {
            alert ("Please provide reason for obsoleting this transformant");
            return;
        }

        const transformant_id = jQuery('#obsolete_transformant_id').val();
        if (!transformant_id) {
            alert ("Error retrieving transformant stock id");
            return;
        }

        const transformant_name = jQuery('#obsolete_transformant_name').val();
        if (!transformant_name) {
            alert ("Error retrieving transformant name");
            return;
        }

        const confirmation = confirm('Are you sure you want to obsolete this transformant?' + "  " + transformant_name);

        if (confirmation) {
            jQuery.ajax({
                url: '/stock/obsolete',
                data : {
                    'stock_id' : transformant_id,
                    'is_obsolete': 1,
                    'comments':comments,
                },
                beforeSend: function(response){
                    jQuery('#working_modal').modal('show');
                },
                success: function(response){
                    console.log(response);
                    jQuery('#working_modal').modal('hide');
                    jQuery('#obsolete_transformant_dialog').modal('hide');
                    jQuery('#obsolete_transformant_message_dialog').modal('show');
                },
                error: function(response){
                    jQuery('#working_modal').modal('hide');
                    alert("Error obsoleting transformant.");
                }
            });
        }
    });

    jQuery("#dismiss_obsolete_transformant_message_dialog").click(function(){
        location.reload();
    });

});

function obsoleteTransformantDialog(transformant_id, transformant_name){

    let html = '';
    html = html + '<form class="form-horizontal"><div class="form-group"><label class="col-sm-4 control-label">Transformant Name: </label><div class="col-sm-8" ><input class="form-control" id="obsolete_transformant_name" name="obsolete_transformant_name" value="'+transformant_name+'" disabled></div></div>';
    html = html + '<div class="form-group"><label class="col-sm-4 control-label">Comments: </label><div class="col-sm-8" ><input class="form-control" id="obsolete_transformant_comments" name="obsolete_transformant_comments" placeholder=""></div></div></form>';
    html = html + '<div class="form-group"><input id="obsolete_transformant_id" type="hidden" value="'+transformant_id+'"/>';

    jQuery('#obsolete_transformant_div').html(html);
    jQuery('#obsolete_transformant_dialog').modal('show');

}



</script>
