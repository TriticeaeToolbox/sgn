<%args>

$programs => undef
$program_id => undef
$program_name => undef

</%args>

<& /util/import_javascript.mas, classes => ['CXGN.TrialTreeFolders'] &>


<div class="modal fade" id="add_autogenerated_name_metadata_dialog" name="add_autogenerated_name_metadata_dialog" tabindex="-1" role="dialog" aria-labelledby="addAutogeneratedNameMetadataDialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header" style="text-align: center">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="addAutogeneratedNameMetadataDialog">Add Autogenerated Name Metadata</h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <form class="form-horizontal" id="add_new_autogenerated_name_metadata_form" name="add_new_autogenerated_name_metadata_form">
% if ($programs) {
                        <div class="form-group">
                            <label class="col-sm-4 control-label">Breeding Program: </label>
                            <div class="col-sm-8">
                                <select class="form-control" id="autogenerated_name_metadata_program" name="autogenerated_name_metadata_program">
                                    <option value="">Select Breeding Program</option>
<%perl>
foreach my $program (@$programs) {
if (@$program[3]) {
print "<option selected=\"selected\" value='".@$program[0]."'>".@$program[1]."</option>";
} else {
print "<option value='".@$program[0]."'>".@$program[1]."</option>";
}
}
</%perl>
                                </select>
                            </div>
                        </div>
% } elsif ($program_name) {
                        <div class="form-group">
                            <label class="col-sm-3 control-label">Breeding Program: </label>
                            <div class="col-sm-9">
                                <select class="form-control" id="autogenerated_name_metadata_program" name="autogenerated_name_metadata_program">
                                    <option value="<%$program_id%>"><%$program_name%></option>
                                </select>
                            </div>
                        </div>
% }
                        <div class="form-group">
                            <label class="col-sm-4 control-label">Format Name: </label>
                            <div class="col-sm-8">
                                <input class="form-control" id="format_name" name="format_name" type="text" placeholder="For example: Breedbase_transformants"/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 control-label">Description: </label>
                            <div class="col-sm-8">
                                <input class="form-control" id="autogenerated_name_metadata_description" name="autogenerated_name_metadata_description" type="text" placeholder="Optional" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 control-label">Autogenerated Names for: </label>
                            <div class="col-sm-8">
                                <select class="form-control" id="name_type">
                                    <option value="">Select a type</option>
                                    <option value="transformant">transformant (accession)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 control-label">How many attributes for basename: </label>
                            <div class="col-sm-8">
                                <select class="form-control" id="number_of_attributes">
                                    <option value="">Select a number</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                        </div>
                        <div id ="name_attributes_form_div">
                        </div>
                        <div class="form-group">
                            <label class="col-sm-4 control-label">Last Serial Number: </label>
                            <div class="col-sm-8">
                                <input class="form-control" id="last_number" name="last_number" type="number" placeholder="For example: value 0. The next name would be BTI1"/>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="new_autogenerated_name_metadata_submit">Submit</button>
            </div>
        </div>
    </div>
</div>



<script>

jQuery(document).ready(function(){

    jQuery("[name='add_autogenerated_name_metadata_link']").click(function(e) {
        e.preventDefault();
        jQuery("#add_autogenerated_name_metadata_dialog").modal("show");
    });

    jQuery("#number_of_attributes").change(function() {
        number_of_attributes = jQuery('#number_of_attributes').val();
        if (number_of_attributes){
            name_attributes_form();
        }
    })

    function name_attributes_form () {
        let number_of_attributes = parseInt(jQuery('#number_of_attributes').val());

        let html = '<table class="table table-bordered" id="name_attributes_table"><thead><tr><th>Attribute Order</th><th>Select Attribute</th></tr></thead><tbody>';
        for(let i=0; i<number_of_attributes; i++){
            let attribute_order = i+1;
            html = html + '<tr><td>' + attribute_order + '</td><td><div name="attribute_selects" id="attribute_select_' +i+ '"></div></td><td><span id="selected_attribute_'+ i +'_string" data-related="'+encodeURI(attribute_order)+'" ></span></td></tr>';
        };
        html = html + '</tbody></table>';

        jQuery('#name_attributes_form_div').html(html);

        let attribute_list = jQuery('#name_attributes_table')
            .find("div")
            .map(function() { return this.id; })
            .get();
        for(let i=0; i<attribute_list.length; i++){
            get_select_box('related_attributes', attribute_list[i], {'name' : 'selected_attribute', 'id' : 'selected_attribute_'+i,  });
        };
    };

    jQuery(document).on('change', "select[name='selected_attribute']", function() {
        var div_id = '#' + this.id;
        let attribute = jQuery(div_id).val();
        if (attribute == 'text') {
            attribute_string(div_id, div_id + '_string');
        }
    });

    function attribute_string(div_id, select_id){
        var attribute_text = jQuery(div_id).val();
        var html = '<table class="table table-bordered" div="' + div_id +'_table"><thead><tr><th></th></tr></thead><tbody>';
        html = html + '<tr><td><input class="form-control"  name ="select_id" id="select_id" value="" placeholder="Please enter text string"/></td></tr>';
        html = html + '</tbody></table>';
        jQuery(select_id).html(html);

    };

    jQuery('#new_autogenerated_name_metadata_submit').click(function(e){
        e.preventDefault();
        let name_attributes = [];

        jQuery('select[name="selected_attribute"]').each(function() {
            value = this.value;
            let text_string;
            if (value == 'text') {
                text_string =  jQuery('#select_id').val();
                name_attributes.push({'text':text_string});
            } else {
                name_attributes.push(value);
            }
        });

        let breeding_program = jQuery('#autogenerated_name_metadata_program').val();
        if (!breeding_program) {
            alert("Breeding program is required");
            return;
        }

        let format_name = jQuery('#format_name').val();
        if (!format_name) {
            alert("Format name is required");
            return;
        }

        let description = jQuery('#autogenerated_name_metadata_description').val();

        let name_type = jQuery('#name_type').val();
        if (!name_type) {
            alert("Name type is required");
            return;
        }

        let last_serial_number = jQuery('#last_number').val();
        if (!last_serial_number) {
            alert("Last serial number is required");
            return;
        }

        jQuery.ajax({
            url: '/ajax/transformation/add_autogenerated_name_metadata',
            method: 'POST',
            data: {
                'breeding_program': breeding_program,
                'format_name': format_name,
                'description': description,
                'name_type': name_type,
                'last_serial_number': last_serial_number,
                'name_attributes': JSON.stringify(name_attributes),
            },
            dataType:'json',
            beforeSend: function() {
                jQuery("#working_modal").modal("show");
            },
            success: function(response) {
                jQuery("#working_modal").modal("hide");
                if (response.error) {
                    alert(response.error);
                } else {

                }
            },
            error: function() {
                jQuery("#working_modal").modal("hide");
                alert('An error occurred storing autogenerated name metadata.');
                jQuery('#add_autogenerated_name_metadata_dialog').modal("hide");
            },
        });

    });

});

</script>
