
<%args>
$user_id => undef
$locations => ()
</%args>

<& /util/import_javascript.mas, classes => [ ] &>

<%perl>

  if (!$locations) {
    print "<tr><td>No locations have been added yet.</td></tr>";
  }

print "<table class=\"table table-striped table-hover table-condensed\">";

foreach my $prog (sort keys %$locations) {

  print "<thead><tr class=\"success\"><td colspan=\"2\"><h4>$prog</h4></td></tr>
  	 <tr><th>Location</th><th>Count</th></tr>
  	 </thead>
	 <tbody>";

  foreach my $loc (@{$locations->{$prog}}) {

    my $delete_link = "";
    if (!$loc->[2] && $user_id) {
      $delete_link = "&nbsp;&nbsp;&nbsp;<a href=\"javascript:delete_location($loc->[0])\"><font style=\"color: red; font-weight: bold\">X</a>";
    }

    print "<tr><td>".$loc->[1]."</td><td>(<a href=\"\">".$loc->[2]." trials</a>) $delete_link</td></tr>";
   }

   print "</tbody><thead><tr style=\"height:30px\"><td colspan=\"2\"></td></tr></thead>";
}

print "</table>";

</%perl>

<div class="modal fade" id="add_location_dialog" name="add_location_dialog" tabindex="-1" role="dialog" aria-labelledby="addLocationDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="addLocationDialog">Add New Location</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
	  <form class="form-horizontal" role="form" name="new_location_form" id="new_location_form">
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Name: </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="location_description" id="location_description" type="text" />
              </div>
	    </div>
      <div class="form-group">
              <label class="col-sm-2 control-label">Latitude: </label>
              <div class="col-sm-10">
    <input class="form-control" name="latitude" id="latitude" type="text" size="4"/>
              </div>
      </div>
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Longitude: </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="longitude" id="longitude" type="text" size="4"/>
              </div>
	    </div>
	    <div class="form-group">
      	      <label class="col-sm-2 control-label">Altitude (m): </label>
      	      <div class="col-sm-10">
		<input class="form-control" name="altitude" id="altitude" type="text" size="4"/>
              </div>
	    </div>
	  </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" name="new_location_submit" id="new_location_submit">Add Location</button>
      </div>
    </div>
  </div>
</div>

<!--
<div id="add_location_dialog"  class="ui-widget" >

Name <input id="location_description" size="20" /><br /><br />
Latitude <input id="latitude" name="latitude" size="4" />
&nbsp;&nbsp;Longitude <input id="longitude" name="longitude" size="4" />
&nbsp;&nbsp;Altitude (m)<input id="altitude" name="altitude" size="4" />

</div>
-->

<script defer="defer">

jQuery(document).ready(function() {

  //jQuery('#add_location_dialog').dialog( {
  //   autoOpen: false,
  //   buttons:  { "Cancel" : { text: "Cancel",
  //                            id: "cancel_new_location_button",
  //                            click: function() { jQuery('#add_location_dialog').dialog("close"); }
  //                          },
  //                   "Add": { text: "Add",
  //                            id: "add_new_location_button",
  //                            click: function() { save_location_info(); }
  //                           }
  //             },
  //   modal: true,
  //   width: 500,
  //   height: 200,
  //   title: "Add new location"
  //
 // });

  $('#add_location_link').click( function() {
      $('#add_location_dialog').modal("show");
   });

  $('button#new_location_submit').click( function(event) {
      event.preventDefault();
      var desc = $('#location_description').val();
      var longitude = $('#longitude').val();
      var latitude = $('#latitude').val();
      var altitude = $('#altitude').val();

      if (desc == '') { alert('Description is required.');  return; }

      $.ajax({
        type: 'POST',
        url: '/ajax/breeders/location/insert',
        data: { 'description': desc,  'longitude':longitude, 'latitude':latitude, 'altitude': altitude },
        success: function(response) {
                 if (response.error) { alert(response.error); }
                 else {
                     alert('The new location was saved.');
                     $('#add_location_dialog').modal("hide");
                     location.reload();
                 }
                },
        error: function() { alert('An error occurred. Please try again later.'); }
      });
  });


  //function save_location_info() {
  //   var desc = jQuery('#location_description').val();
  //   var longitude = jQuery('#longitude').val();
  //   var latitude = jQuery('#latitude').val();
  //   var altitude = jQuery('#altitude').val();
  //
  //   if (desc == '') { alert('Description is required.');  return; }
  //
  //   new jQuery.ajax( {
  //     type: 'POST',
  //     url: '/ajax/breeders/location/insert',
  //     data: { 'description': desc,  'longitude':longitude, 'latitude':latitude, 'altitude': altitude },
  //     success: function(response) {
  //                if (response.error) { alert(response.error); }
  //                else {
  //                   alert('The new location was saved.');
  //                   jQuery('#add_location_dialog').dialog("close");
 //                    location.reload();
  //                }
  //              },
   //    error: function() { alert('An error occurred. Please try again later.'); }
  //   });
 // }

});


  function delete_location(location_id) {

    var yes = confirm('Are you sure you want to delete location with id '+location_id+'? ');

    if (! yes) { return; }

    new jQuery.ajax( {
      type: 'POST',
      url: '/ajax/breeders/location/delete/'+location_id,
      success: function(response) {
                  if (response.error) { alert(response.error); }
                  else {
                    alert("The location was deleted.");
		    location.reload();
                  }
               },
      error: function(response) {
                 alert("An error occurred");
             }
      });
   }


</script>
