
<%args>
$trial_id
$stockref => undef
</%args>

<style>
#plot_images_results {
    width: 100% !important;
}
</style>

<& /util/import_javascript.mas, classes => [ 'jquery', 'thickbox', 'jquery.dataTables' ] &>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip-utils/0.0.2/jszip-utils.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<div class="well well-sm table-responsive">
    <table id="plot_images_results" class="table table-hover table-striped">
    <thead>
        <tr>
        <th>Image</th>
        <th>File Name/Details</th>
        <th>Description</th>
        <th>Submitter</th>
        <th>Associations</th>
        <th>Accession Name</th>
    </tr>
    </thead>
    </table>
</div>
            

<script>

<%perl>
my $dbh = $stockref->{dbh};
</%perl>

var trial_id = '<% $trial_id %>';
var plotNames = [];
var auth_token;
    var require_login = "<% $c->get_conf('brapi_require_login') %>";
    auth_token = "<% CXGN::Login->new($c->dbc->dbh)->get_login_cookie() %>";

    if (require_login == '1'){
        auth_token = "<% CXGN::Login->new($c->dbc->dbh)->get_login_cookie() %>";
        if (!auth_token){
            alert("Login required to display");
        }
    }

jQuery(document).ready( function() {

    jQuery('#image_download_button').click(function () {
        var zip = new JSZip();
        var zipFilename = "trial_" + trial_id + "_images.zip";
        var datatable = jQuery('#plot_images_results').DataTable();
        var imageUrls = [];
        var fileNames = [];

        datatable.rows().every(function () {
            var data = this.data();
            var imageUrl = jQuery(data[0]).find('img').attr('src');
            var fileName = jQuery('<div>').html(data[1]).find('a').text();

            if (imageUrl) {
                var fileExtension = imageUrl.split('.').pop();
                imageUrl = imageUrl.replace('medium', fileName);
                imageUrls.push(imageUrl);
                fileNames.push(fileName + '.' + fileExtension);
            }
        });

        var count = 0;
        imageUrls.forEach(function (url, index) {
            var filename = fileNames[index];
            JSZipUtils.getBinaryContent(url, function (err, data) {
                if (err) {
                    throw err;
                }
                zip.file(filename, data, { binary: true });
                count++;
                if (count == imageUrls.length) {
                    zip.generateAsync({ type: 'blob' }).then(function (content) {
                        saveAs(content, zipFilename);
                    });
                }
            });
        });
    });

    jQuery('#trial_images_section_onswitch').click(function() {
        getObservationUnits()
    });

    jQuery('#plot_images_results').on( 'draw.dt', function () {
        jQuery('a.image_search_group').colorbox();
    });
});

function getObservationUnits() {
    var trial_ids = [trial_id];

    jQuery.ajax({
        headers: (auth_token) ? {'Authorization': `Bearer ` + auth_token } : {},
        method: 'GET',
        url: '/brapi/v2/observationunits',
        data: {
            studyDbIds: trial_ids,
            pageSize: 10000
        },
        beforeSend: function() {
            jQuery("#working_modal").modal("show");
        },
        success: function(response) {
            var data = response.result.data;
            data.forEach(function(unit) {
                plotNames.push(unit.observationUnitName);
            });
            _load_stock_image_results();
        },
        error: function(response) {
            alert('Error fetching observation units');
        },
        complete: function() {
            jQuery("#working_modal").modal("hide");
        }
    });
}

function _load_stock_image_results() {
    var plotNamesString = plotNames.join(',');

    plot_images_table = jQuery('#plot_images_results').DataTable({
        'destroy' : true,
        'searching' : true,
        'ordering' : true,
        'processing' : true,
        //'serverSide': true,
        'scrollX': true,
        'lengthMenu': [10,20,50,100,1000,5000],
        'ajax': { 'url': '/ajax/search/images',
            'data': function(d) {
                d.image_stock_uniquename = plotNamesString;
            },
            'dataSrc': function(json) {
                json.data.forEach(function(row) {
                    var imgElement = jQuery(row[0]).find('img');
                    imgElement.attr('width', '140');
                    var anchorElement = jQuery(row[0]);
                    anchorElement.html(imgElement.prop('outerHTML'));
                    row[0] = anchorElement.prop('outerHTML');
                });
                return json.data;
            }
        },
        'columns': [
            { 'title': 'Image', 
              'data': 0, },
            { 'title': 'File Name/Details', 'data': 1 },
            { 'title': 'Description', 'data': 2 },
            { 'title': 'Submitter', 'data': 3 },
            { 'title': 'Associations', 'data': 4 },
            { 'title': 'Accession Name', 'data': 5 },
        ],
        columnDefs: [
            { "targets": [1,3,4], "type": 'html' },
            { targets: [0], searchable: false }
        ]
    }).on('draw', function() {
        jQuery(".image_search_group").colorbox({rel:'image_search_group'});
    });
}


</script>